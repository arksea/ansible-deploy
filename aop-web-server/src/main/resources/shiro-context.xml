<?xml version="1.0" encoding="UTF-8"?>
<beans  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.springframework.org/schema/beans"
        xsi:schemaLocation="
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"
        default-lazy-init="true">

    <description>Shiro权限管理配置</description>

    <bean id="shiroFilter" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean">
        <property name="securityManager" ref="securityManager"/>
        <property name="loginUrl" value="/index.html"/>
        <property name="successUrl" value="/index.html"/>
        <property name="unauthorizedUrl" value="/index.html"/>
        <property name="filterChainDefinitions">
            <value>
                /** = anon
            </value>
        </property>
    </bean>

    <bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager">
        <property name="realm" ref="authRealm"/>
        <property name="cacheManager" ref="cacheManager"/>
        <property name="sessionManager" ref="sessionManager"/>
        <property name="rememberMeManager" ref="rememberMeManager"/>
    </bean>

    <!-- 虽然没用到session但shiro自动生成的jsession没有设置SameSite属性，会造成Firefox警告“cookie将来会被拒绝”，
    所以这里自定义生成sessionIdCookie对象，不修改SameSite属性（SameSite构造函数默认值为lax）
    -->
    <bean id="sessionManager" class="org.apache.shiro.web.session.mgt.DefaultWebSessionManager">
        <property name="sessionIdUrlRewritingEnabled" value="false" />
    </bean>
    <bean id="sessionIdCookie" class="org.apache.shiro.web.servlet.SimpleCookie">
        <constructor-arg value="sid"/>
        <property name="httpOnly" value="true"/>
        <property name="maxAge" value="-1"/>
    </bean>

    <!-- shiro1.4还有一个bug，就是在subject.logout()或login()时，会在返回头中设置一个rememberMe=deleteMe来覆盖
         浏览器上当前的有效cookie，而这个cookie的生成是写死在代码里的，设置SameSite属性为null，造成Firefox警告“cookie将来会被拒绝”
         org.apache.shiro.web.servlet.SimpleCookie.java:
         public void removeFrom(HttpServletRequest request, HttpServletResponse response) {
            ...
            SameSiteOptions sameSite = null;
            ...
        }
        这个问题在shiro1.7已修正，如上代码改成了： SameSiteOptions sameSite = getSameSite();
    -->

    <bean id="rememberMeManager" class="org.apache.shiro.web.mgt.CookieRememberMeManager">
        <property name="cipherKey" value="#{T(org.apache.shiro.codec.Base64).decode('${shiro.cipherKey}')}"/>
        <property name="cookie" ref="rememberMeCookie"/>
    </bean>
    <bean id="rememberMeCookie" class="org.apache.shiro.web.servlet.SimpleCookie">
        <constructor-arg value="rememberMe"/>
        <property name="httpOnly" value="true"/>
        <property name="maxAge" value="2592000"/>
    </bean>

    <bean id="authRealm" class="net.arksea.ansible.deploy.api.auth.service.AuthRealm">
        <property name="authService" ref="authService"/>
        <property name="credentialsMatcher" ref="credentialsMatcher"/>
    </bean>

    <bean id="cacheManager" class="org.apache.shiro.cache.MemoryConstrainedCacheManager"/>

</beans>
